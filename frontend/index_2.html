<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Lamp control</title>
	</head>
	<body>
		<div id="timeline">
			<p class="font-header color-white">Timeline</p>
			<div id="timeline-inner"></div>
		</div>
		<div id="widgets">
			<div class="widget">
				<p class="widget-header">Color Type</p>
				<div class="widget-body simple-select">
					<button class="btn-active">Solid</button>
					<button class="btn-inactive">Gradient</button>
					<button class="btn-inactive">Draw</button>
				</div>
			</div>
			<div class="color-widget"></div>
			<div class="widget">
				<p class="widget-header">Duration</p>
				<div class="widget-body duration-widget">
					<button class="btn-filled">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M200-440v-80h560v80H200Z" />
						</svg>
					</button>
					<div class="duration-middle">
						<input type="number" id="time-teller" onchange="changeTime(this.value)" min="0" max="10000" value="10" />
						<p>min</p>
					</div>
					<button class="btn-filled">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
						</svg>
					</button>
				</div>
			</div>
			<div class="widget">
				<p class="widget-header">Duration type</p>
				<div class="widget-body simple-select">
					<button class="btn-active">Seconds</button>
					<button class="btn-inactive">Minutes</button>
					<button class="btn-inactive">Hours</button>
				</div>
			</div>
			<div class="widget-halfed">
				<div class="widget">
					<p class="widget-header">Lamp<br />Wakeup</p>
					<div class="widget-body">
						<input type="time" class="lamp-wake wakeup" />
					</div>
				</div>
				<div class="widget">
					<p class="widget-header">Lamp<br />Sleep</p>
					<div class="widget-body">
						<input type="time" class="lamp-wake sleep" />
					</div>
				</div>
			</div>
		</div>
		<!--
		<div id="settings-area">
			<div id="buttons">
				<button onclick="getData()">HK</button>
				<button>ADAPTIVE</button>
				<button id="btn_on" onclick="onOff()">ON</button>
			</div>
			<div class="timeline">
				<p class="upperc">Timeline</p>
				<div id="times">
					<button class="time-entry clone" time="5" onclick="handleTimeline(this)">
						<div class="time-color"></div>
						<p class="time-text small">00 min</p>
						<svg height="10px" viewBox="0 0 10 10">
							<circle cx="50%" cy="50%" r="40%" fill="white" />
						</svg>
					</button>
					<button class="time-entry-add" onclick="handleTimeline()">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
						</svg>
					</button>
					<button id="time-entry-restart" onclick="toggleRestart()">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path
								d="M314-115q-104-48-169-145T80-479q0-26 2.5-51t8.5-49l-46 27-40-69 191-110 110 190-70 40-54-94q-11 27-16.5 56t-5.5 60q0 97 53 176.5T354-185l-40 70Zm306-485v-80h109q-46-57-111-88.5T480-800q-55 0-104 17t-90 48l-40-70q50-35 109-55t125-20q79 0 151 29.5T760-765v-55h80v220H620ZM594 0 403-110l110-190 69 40-57 98q118-17 196.5-107T800-480q0-11-.5-20.5T797-520h81q1 10 1.5 19.5t.5 20.5q0 135-80.5 241.5T590-95l44 26-40 69Z"
							/>
						</svg>
					</button>
				</div>
			</div>
			<div class="color">
				<p class="upperc">Shown color(s) per timestamp</p>
				<div id="colors">
					<input
						type="color"
						onclick="checkForColorDeletion(event, this)"
						onchange="handleColor(this, this.value)"
						value="#fffffff"
						class="color-entry clone"
					/>
					<button class="time-entry-add" onclick="handleColor(this)">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
						</svg>
					</button>
				</div>
			</div>
			<div class="pattern">
				<p class="upperc">Patterns the colors are shown in</p>
				<div id="patterns">
					<button class="pattern-waves" pattern="waves" onclick="handlePattern('waves')"></button>
				</div>
			</div>
			<div id="time">
				<p class="upperc">Minutes the timestamp is shown</p>
				<div>
					<button id="minus" onclick="changeTime(-1)">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M200-440v-80h560v80H200Z" />
						</svg>
					</button>
					<input type="number" id="time-teller" onchange="changeTime(this.value)" min="0" max="10000" value="10" />
					<button id="plus" onclick="changeTime(1)">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
						</svg>
					</button>
				</div>
			</div>
		</div>
		<button onclick="set()" id="sendBtn">update</button>
		<div id="snackbar">
			<p id="snackbarText"></p>
		</div>
	-->
	</body>
	<style>
		* {
			margin: 0;
			box-sizing: border-box;
		}
		p,
		button,
		input {
			color: white;
			font-size: var(--regular);
			font-family: Arial, Helvetica, sans-serif;
		}
		:root {
			--white: #ffffff;
			--bg: #1c1c1c;
			--grey: #575757;
			--red: #ff4d4d;
			--areaHighlight: #212121;

			--radius: 25px;
			--margin: 10px;

			--header: 2rem;
			--regular: 1rem;
			--small: 0.8rem;
		}
		body {
			background-color: var(--bg);
			padding: var(--margin);
			max-width: 600px;
			margin: 0 auto;
		}

		/*global styles*/
		.font-header {
			font-size: var(--header);
		}
		.color-white {
			color: var(--white);
		}
		.btn-active,
		.btn-inactive,
		.btn-filled {
			padding: calc(var(--margin) * 1.5) var(--margin);
			border-radius: 500px;
		}
		.btn-active {
			background-color: transparent;
			border: 1px solid var(--white);
		}
		.btn-inactive {
			background-color: transparent;
			border: 1px solid var(--grey);
		}
		.btn-filled {
			background-color: var(--grey);
			border: none;
		}

		/*widgets*/
		#widgets {
			display: flex;
			flex-direction: column;
			gap: calc(var(--margin) / 2);
		}
		.widget-halfed {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			grid-column-gap: calc(var(--margin) / 2);
		}
		.widget {
			background-color: var(--areaHighlight);
			padding: calc(var(--margin) * 1.5);
			border-radius: var(--radius);
			border: 1px solid var(--grey);
			min-height: 45vw;
			display: flex;
			flex-direction: column;
		}
		.widget > .widget-header {
			flex-grow: 1;
		}

		.simple-select {
			display: flex;
			flex-wrap: wrap;
		}
		.simple-select > button {
			flex-grow: 1;
		}

		/*lamp wakeup and slee*/
		.lamp-wake {
			background-color: transparent;
			border: none;
			font-size: var(--header);
			padding: 0;
		}

		/*duration*/
		.duration-widget {
			display: flex;
		}
		.duration-widget > button {
			aspect-ratio: 1;
			flex-shrink: 0;
		}
		.duration-middle {
			display: flex;
			flex-grow: 1;
			justify-content: center;
			align-items: center;
		}
		.duration-middle > input {
			font-size: var(--header);
			background-color: transparent;
			width: 4rem;
			border: none;
		}

		#buttons {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			grid-template-rows: 1fr;
			grid-column-gap: 1px;
			grid-row-gap: 0px;
			background-color: var(--grey);
			padding: 0 1px 1px 1px;
		}
		#buttons > button {
			background-color: transparent;
			border: none;
			background-color: var(--bg);
			padding: calc(var(--margin) * 2);
			font-size: var(--small);
		}

		#settings-area {
			flex-grow: 1;
			overflow-y: scroll;
		}

		.upperc {
			text-transform: uppercase;
			font-weight: bold;
			margin-bottom: var(--margin);
		}
		.small {
			font-size: var(--small);
		}

		#buttons,
		.timeline,
		.color,
		#time,
		.pattern {
			margin-bottom: calc(var(--margin) * 4);
		}
		#times {
			border-top: 1px solid var(--grey);
			border-bottom: 1px solid var(--grey);
			padding-top: var(--margin);
		}
		#times,
		#colors {
			display: flex;
			gap: var(--margin);
			overflow-x: scroll;
		}
		#times {
			padding-bottom: calc(var(--small) + var(--margin) * 2 + 2px);
		}
		.time-entry {
			position: relative;
			border: none;
			background-color: transparent;
			padding: 0;
		}
		.time-entry.active svg {
			display: block;
		}
		.time-entry.clone,
		.color-entry.clone {
			display: none;
		}
		.time-entry > p {
			text-align: center;
			position: absolute;
			width: 100%;
			white-space: nowrap;
			overflow: hidden;
		}
		.time-entry > svg {
			display: none;
			position: absolute;
			bottom: calc((var(--small) + var(--margin) * 2) * -1);
			left: 50%;
			transform: translateX(-50%);
		}
		.time-color {
			width: calc(var(--margin) * 5);
			height: calc(var(--margin) * 15);
			background-color: red;
			border-radius: var(--radius);
		}
		#colors > * {
			width: calc(var(--margin) * 6);
			height: calc(var(--margin) * 4);
		}
		.time-entry-add {
			background-color: transparent;
			border: var(--border);
			width: calc(var(--margin) * 5);
			border-radius: var(--radius);
			flex-shrink: 0;
		}
		#time-entry-restart {
			background-color: transparent;
			border: none;
		}

		#time > div {
			display: flex;
			align-items: center;
		}
		#time > div > * {
			flex-grow: 1;
			text-align: center;
			border-radius: var(--radius);
			height: calc(var(--margin) * 4);
		}
		#time button {
			background-color: transparent;
			border: var(--border);
		}
		#time input {
			background-color: transparent;
			border: none;
		}
		.color-entry {
			appearance: none;
			background-color: transparent;
			border: none;
			padding: 0;
			border-radius: var(--radius);
			flex-shrink: 0;
		}
		#patterns {
			display: flex;
			gap: var(--margin);
		}
		#patterns > button {
			width: calc(var(--margin) * 6);
			height: calc(var(--margin) * 4);
			border-radius: var(--radius);
			border: none;
			background-color: var(--grey);
		}
		#patterns > .focus {
			border: 3px solid white !important;
		}
		.pattern-waves {
			background: linear-gradient(
				90deg,
				rgba(170, 170, 170, 1) 0%,
				rgba(97, 97, 97, 1) 20%,
				rgba(170, 170, 170, 1) 40%,
				rgba(97, 97, 97, 1) 60%,
				rgba(170, 170, 170, 1) 80%,
				rgba(97, 97, 97, 1) 100%
			);
		}
		.pattern-pulse {
		}
		#sendBtn {
			width: 100%;
			background-color: transparent;
			border: 1px solid #fff;
			border-radius: var(--radius);
			height: calc(var(--margin) * 4);
			text-transform: uppercase;
			font-weight: bold;
			margin-top: var(--margin);
		}

		div#snackbar {
			position: fixed;
			bottom: 0;
			width: calc(100% - 2 * var(--margin));
			padding: var(--margin);
			background-color: white;
			border-radius: var(--radius);
			transition: all 0.5s;
			transform: translateY(0px);
			opacity: 0;
			pointer-events: none;
		}
		p#snackbarText {
			color: black;
			font-size: var(--small);
		}
	</style>
	<script>
		let data = {
			on: false,
			restart: true,
			activeTime: 0,
			activeColor: 0,
			times: [
				{
					time: 5,
					colors: ["#ffffff"],
					pattern: "waves",
				},
			],
		};
		let hasChanges = false;
		function onOff() {
			if (data.on) {
				data.on = false;
			} else {
				data.on = true;
			}
			hasChanges = true;
			set();
			render();
		}
		function toggleRestart() {
			data.restart = !data.restart;
			hasChanges = true;
			render();
		}
		function handleTimeline(el) {
			if (el) {
				let elI = parseInt(el.getAttribute("index"));
				if (data.activeTime == elI && data.times.length > 1) {
					if (window.confirm("Delete the timestamp?")) {
						data.times.splice(elI, 1);
						if (data.activeTime == data.times.length) {
							data.activeTime -= 1;
						}
						snackbar("Timestamp deleted");
					}
				} else {
					data.activeTime = parseInt(el.getAttribute("index"));
				}
			} else {
				data.times.push({ time: 5, colors: ["#ffffff"], pattern: "solid" });
				data.activeTime = data.times.length - 1;
			}
			hasChanges = true;
			render();
		}
		function changeTime(type) {
			if (type == 1 || type == -1) {
				data.times[data.activeTime].time += 1 * type;
			} else {
				data.times[data.activeTime].time = parseInt(type);
			}
			if (data.times[data.activeTime].time < 1) data.times[data.activeTime].time = 1;
			hasChanges = true;
			render();
		}
		let lastClickedColor = -1;
		function checkForColorDeletion(event, el, value) {
			if (data.times[data.activeTime].colors.length == 1) {
				return;
			}
			let index = el.getAttribute("index");
			if (index === lastClickedColor) {
				event.preventDefault();
				if (window.confirm("Delete the color?")) {
					data.times[data.activeTime].colors.splice(index, 1);
					hasChanges = true;
					render();
					snackbar("Color deleted");
				}
			}
			lastClickedColor = index;
		}
		function handleColor(el, color) {
			console.log(data.activeColor, data.times[data.activeTime]);
			if (color) {
				data.activeColor = parseInt(el.getAttribute("index"));
				data.times[data.activeTime].colors[data.activeColor] = color;
			} else {
				data.activeColor = data.times[data.activeTime].colors.length;
				data.times[data.activeTime].colors.push("#ffffff");
			}
			hasChanges = true;
			render();
		}
		function buildStyle(colors) {
			let c = "linear-gradient(180deg, ";
			if (colors.length === 1) {
				return `linear-gradient(0deg, ${colors[0]} 0%, ${colors[0]} 100%)`;
			}
			const step = 100 / (colors.length - 1);
			colors.forEach((co, i) => {
				const pct = (step * i).toFixed(2);
				c += `${co} ${pct}%, `;
			});
			c = c.replace(/, $/, "") + ")";
			return c;
		}
		function handlePattern(pattern) {
			data.times[data.activeTime].pattern = pattern;
			hasChanges = true;
			render();
		}
		function render() {
			let parent = document.querySelector("#times");
			let toDel = document.querySelectorAll(".delete-on-rerender");
			let restartIndicator = document.querySelector("#time-entry-restart");
			if (data.restart) {
				restartIndicator.style.opacity = 1;
			} else {
				restartIndicator.style.opacity = 0.2;
			}
			document.querySelector("#btn_on").innerText = data.on ? "ON" : "OFF";
			document.querySelector("#sendBtn").style.opacity = hasChanges ? 1 : 0.5;
			toDel.forEach((el, i) => {
				el.remove();
			});
			data.times.forEach((el, i) => {
				let clone = document.querySelector(".time-entry.clone").cloneNode(true);
				clone.classList.remove("clone");
				clone.querySelector(".time-text").innerText = el.time + " min";
				let cStyler = clone.querySelector(".time-color").style;
				cStyler.background = buildStyle(el.colors);
				cStyler.width = `calc(${el.time} * var(--margin))`;
				clone.setAttribute("index", i);
				if (data.activeTime == i) {
					clone.classList.add("active");
					document.querySelector("#time-teller").value = el.time;
					let cParent = document.querySelector("#colors");
					el.colors.forEach((col, cI) => {
						let cClone = document.querySelector(".color-entry.clone").cloneNode(true);
						cClone.classList.remove("clone");
						cClone.value = col;
						cClone.classList.add("delete-on-rerender");
						cClone.setAttribute("index", cI);
						cParent.insertBefore(cClone, cParent.childNodes[cParent.childNodes.length - 2]);
					});
					document.querySelector(".pattern").style.display = el.colors.length == 1 ? "none" : "block";
					document.querySelectorAll("[pattern]").forEach((pat) => {
						pat.classList.remove("focus");
						if (pat.getAttribute("pattern") == el.pattern) {
							pat.classList.add("focus");
						}
					});
				}
				clone.classList.add("delete-on-rerender");
				parent.insertBefore(clone, parent.childNodes[parent.childNodes.length - 4]);
			});
		}
		render();
		async function set() {
			if (!hasChanges) {
				return;
			}
			try {
				let res = await fetch("/set", {
					method: "POST",
					body: JSON.stringify(data),
				});
				if (res.ok) {
					hasChanges = false;
					render();
					snackbar("Updated");
				} else {
					snackbar("Error while updating, reload and try again.", true);
				}
			} catch (e) {
				snackbar("Error", true);
				console.error(e);
			}
		}
		async function getData() {
			try {
				let res = await fetch("/state");
				if (res.ok) {
					let serialized = await res.json();
					console.log(serialized);
					if (serialized) {
						data = serialized;
						render();
					}
				} else {
					console.error("Couldn't get state", res);
					snackbar("Couldn't get state, restart lamp and try again", true);
				}
			} catch (e) {
				console.error(e);
				snackbar("Error", true);
			}
		}
		getData();

		function snackbar(msg, isError = false) {
			let elem = document.querySelector("#snackbar");
			let txt = document.querySelector("#snackbarText");
			txt.innerText = msg;

			elem.style.backgroundColor = isError ? "var(--red)" : "white";

			elem.style.transform = "translateY(calc(var(--margin) * -1))";
			elem.style.opacity = 1;
			elem.style.pointerEvents = "all";

			setTimeout(() => {
				elem.style.transform = "translateY(0px)";
				elem.style.opacity = 0;
				elem.style.pointerEvents = "none";
			}, 1500);
		}
	</script>
</html>
