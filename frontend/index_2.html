<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Lamp control</title>
	</head>
	<body>
		<div id="header">
			<button id="power" class="btn-active keep" title="power" onclick="toggleOnOff()">
				<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--white)">
					<path
						d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-84 31.5-156.5T197-763l56 56q-44 44-68.5 102T160-480q0 134 93 227t227 93q134 0 227-93t93-227q0-67-24.5-125T707-707l56-56q54 54 85.5 126.5T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-40-360v-440h80v440h-80Z"
					/>
				</svg>
			</button>
			<button id="visualize" class="btn-active keep" onclick="toggleVisualize()">
				<svg
					id="icon-visualize-shown"
					xmlns="http://www.w3.org/2000/svg"
					height="24px"
					viewBox="0 -960 960 960"
					width="24px"
					fill="var(--white)"
				>
					<path
						d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"
					/>
				</svg>
				<svg
					id="icon-visualize-hidden"
					xmlns="http://www.w3.org/2000/svg"
					height="24px"
					viewBox="0 -960 960 960"
					width="24px"
					fill="var(--white)"
				>
					<path
						d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"
					/>
				</svg>
				<p>Visualize</p>
			</button>
		</div>
		<div id="timeline">
			<p class="font-header color-white">Timeline <span class="font-regular" id="font-header-info">1h</span></p>
			<div id="timeline-inner">
				<button class="time-entry clone" onclick="focusTimeEntry(this)">
					<div class="time-entry-text">
						<p class="time-entry-time font-header">1</p>
						<p class="time-entry-unit font-small">min</p>
					</div>
				</button>
				<button id="timeline-add" onclick="addTimeEntry()">
					<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
						<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
					</svg>
				</button>
			</div>
		</div>
		<div id="widgets">
			<div class="widget-halfed">
				<button class="btn-active keep" onclick="deleteTimeEntry(this)">Delete</button>
				<button class="btn-active keep" onclick="duplicateTimeEntry(this)">Duplicate</button>
			</div>
			<div class="widget">
				<p class="widget-header">Color Type</p>
				<div class="widget-body simple-select">
					<button class="btn-active remove-active type-solid" onclick="changeType('solid')">Solid</button>
					<button class="btn-inactive type-gradient" onclick="changeType('gradient')">Gradient</button>
					<button class="btn-inactive type-draw" onclick="changeType('draw')">Draw</button>
				</div>
			</div>
			<div class="color-widget">
				<p id="color-widget-header">Color</p>
				<button onclick="openSolidColorPicker()"></button>
				<input type="color" id="solidColorInput" onchange="setColor(this)" />
			</div>
			<div class="widget">
				<p class="widget-header">Duration</p>
				<div class="widget-body duration-widget">
					<button class="btn-filled" onclick="changeDuration(-1)">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M200-440v-80h560v80H200Z" />
						</svg>
					</button>
					<div class="duration-middle">
						<input type="number" id="duration-teller" onchange="changeDuration(this.value)" min="0" max="10000" value="10" />
						<p id="duration-unit">min</p>
					</div>
					<button class="btn-filled" onclick="changeDuration(1)">
						<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
							<path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
						</svg>
					</button>
				</div>
			</div>
			<div class="widget">
				<p class="widget-header">Duration type</p>
				<div class="widget-body simple-select">
					<button class="btn-inactive duration-h" onclick="changeUnit('h')">Hours</button>
					<button class="btn-inactive duration-min" onclick="changeUnit('min')">Minutes</button>
					<button class="btn-active remove-active duration-s" onclick="changeUnit('s')">Seconds</button>
				</div>
			</div>
			<div class="widget-halfed">
				<div class="widget">
					<p class="widget-header">Lamp<br />Wakeup</p>
					<div class="widget-body">
						<input type="time" class="lamp-wake wakeup" />
					</div>
				</div>
				<div class="widget">
					<p class="widget-header">Lamp<br />Sleep</p>
					<div class="widget-body">
						<input type="time" class="lamp-wake sleep" />
					</div>
				</div>
			</div>
		</div>
		<div id="snackbar">
			<p id="snackbar-text" class="color-black">test</p>
		</div>
	</body>
	<style>
		* {
			margin: 0;
			box-sizing: border-box;
		}
		p,
		button,
		input {
			color: white;
			font-size: var(--regular);
			font-family: Arial, Helvetica, sans-serif;
		}
		:root {
			--white: #ffffff;
			--black: #000000;
			--bg: #1c1c1c;
			--grey: #575757;
			--red: #ff4d4d;
			--areaHighlight: #212121;

			--radius: 25px;
			--margin: 10px;

			--header: 2rem;
			--regular: 1rem;
			--small: 0.7rem;
		}
		body {
			background-color: var(--bg);
			padding: var(--margin);
			max-width: 600px;
			margin: 0 auto;
		}

		/*global styles*/
		.font-header {
			font-size: var(--header);
		}
		.font-regular {
			font-size: var(--regular);
		}
		.font-small {
			font-size: var(--small);
		}
		.color-white {
			color: var(--white);
		}
		.color-black {
			color: var(--black);
		}

		.bold {
			font-weight: 600;
		}
		.btn-active,
		.btn-inactive,
		.btn-filled {
			padding: calc(var(--margin) * 1.5) var(--margin);
			border-radius: 500px;
		}
		.btn-active {
			background-color: transparent;
			border: 1px solid var(--white);
		}
		.btn-inactive {
			background-color: transparent;
			border: 1px solid var(--grey);
		}
		.btn-filled {
			background-color: var(--grey);
			border: none;
		}

		/*header*/
		#header {
			display: flex;
			justify-content: space-between;
			margin-bottom: calc(var(--margin) * 4);
		}
		#power {
			aspect-ratio: 1;
			padding: calc(var(--margin) * 1.5);
			display: flex;
		}
		#visualize {
			display: flex;
			gap: var(--margin);
			align-items: center;
			padding: calc(var(--margin) * 1.5);
		}
		#icon-visualize-hidden {
			display: none;
		}

		/*timeline*/
		#timeline {
			margin-bottom: calc(var(--margin) * 4);
		}
		#timeline-inner {
			display: flex;
			overflow-x: scroll;
		}
		.time-entry {
			background-color: red;
			padding: var(--margin) 0;
			border-radius: calc(var(--radius) / 2);
			border: none;
			flex-shrink: 0;
			display: flex;
		}
		.time-entry.clone {
			display: none;
		}
		.time-entry-text {
			position: sticky;
			left: 0;
			padding: 0 var(--margin);
		}
		.time-entry-text > p {
			color: var(--black);
		}
		#timeline-add {
			background-color: transparent;
			border-radius: calc(var(--radius) / 2);
			border: 1px solid var(--grey);
			padding: 0 calc(var(--margin) * 2);
		}

		/*widgets*/
		#widgets {
			display: flex;
			flex-direction: column;
			gap: calc(var(--margin) / 2);
		}
		.widget-halfed {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			grid-column-gap: calc(var(--margin) / 2);
		}
		.widget {
			background-color: var(--areaHighlight);
			padding: calc(var(--margin) * 1.5);
			border-radius: var(--radius);
			border: 1px solid var(--grey);
			min-height: 45vw;
			display: flex;
			flex-direction: column;
		}
		.widget > .widget-header {
			flex-grow: 1;
		}

		.simple-select {
			display: flex;
			flex-wrap: wrap;
		}
		.simple-select > button {
			flex-grow: 1;
		}

		/*color widgets*/
		.color-widget {
			background-color: blue;
			border-radius: var(--radius);
			min-height: 45vw;
			position: relative;
		}
		.color-widget > button {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: transparent;
			border: none;
		}
		.color-widget > input {
			position: absolute;
			visibility: hidden;
		}
		#color-widget-header {
			padding: calc(var(--margin) * 1.5);
			pointer-events: none;
			color: var(--black);
		}

		/*lamp wakeup and sleep*/
		.lamp-wake {
			background-color: transparent;
			border: none;
			font-size: var(--header);
			padding: 0;
			width: 100%;
		}

		/*duration*/
		.duration-widget {
			display: flex;
		}
		.duration-widget > button {
			aspect-ratio: 1;
			flex-shrink: 0;
			padding: calc(var(--margin) * 1.5);
		}
		.duration-middle {
			display: flex;
			flex-grow: 1;
			justify-content: center;
			align-items: center;
		}
		.duration-middle > input {
			font-size: var(--header);
			background-color: transparent;
			width: 4rem;
			border: none;
		}

		/*snackbar*/
		#snackbar {
			width: calc(100% - 2 * var(--margin));
			background-color: var(--white);
			position: fixed;
			bottom: 0px;
			transform: translateY(0px);
			border-radius: calc(var(--radius) / 2);
			padding: var(--margin);
			opacity: 0;
			pointer-events: none;
			transition: all 0.2s;
		}
	</style>
	<script>
		function openSolidColorPicker() {
			document.querySelector("#solidColorInput").click();
		}
		let visualizeChanges = true;
		function toggleVisualize() {
			visualizeChanges = !visualizeChanges;
			document.querySelector("#visualize").style.opacity = visualizeChanges ? 1 : 0.3;
			document.querySelector("#icon-visualize-shown").style.display = visualizeChanges ? "block" : "none";
			document.querySelector("#icon-visualize-hidden").style.display = visualizeChanges ? "none" : "block";

			if (visualizeChanges) {
				set();
			}
		}
		let data = {
			on: false,
			restart: true,
			activeTime: 0,
			activeColor: 0,
			times: [
				{
					time: 13,
					unit: "min",
					colors: ["#ffffff"],
					type: "solid",
				},
			],
		};

		function toggleOnOff() {
			data.on = !data.on;
			render();
		}

		function focusTimeEntry(elem) {
			if (elem == undefined) {
				data.activeTime = data.times.length - 1;
				return;
			}
			let indexOfClickedEntry = elem.getAttribute("index");
			data.activeTime = parseInt(indexOfClickedEntry);
			render(true);
		}

		function addTimeEntry(indexToAddAfter, elem) {
			if (indexToAddAfter == undefined) {
				indexToAddAfter = data.times.length;
			}
			let elemToAdd = { time: 1, unit: "min", colors: ["#ffffff"], type: "solid" };
			if (elem) {
				elemToAdd = elem;
			}
			data.times.splice(indexToAddAfter, 0, elemToAdd);
			focusTimeEntry();
			render();
		}

		function deleteTimeEntry() {
			if (data.times.length === 1) return;
			if (window.confirm("Delete the timestamp?")) {
				data.times.splice(data.activeTime, 1);
				if (data.activeTime > 0) {
					data.activeTime -= 1;
				}
				render();
			}
		}

		function duplicateTimeEntry() {
			let clonedEntry = structuredClone(data.times[data.activeTime]);
			addTimeEntry(data.activeTime, clonedEntry);
			render();
		}

		function changeType(type) {
			data.times[data.activeTime].type = type;
			render();
		}

		function setColor(elem) {
			data.times[data.activeTime].colors[0] = elem.value;
			render();
		}

		function changeDuration(type) {
			if (type == 1 || type == -1) {
				data.times[data.activeTime].time += 1 * type;
			} else {
				data.times[data.activeTime].time = parseInt(type);
			}
			if (data.times[data.activeTime].time < 1) data.times[data.activeTime].time = 1;
			render();
		}

		function changeUnit(unit = "min") {
			data.times[data.activeTime].unit = unit;
			render();
		}

		function render(blockLampUpdate = false) {
			let timelineParent = document.querySelector("#timeline-inner");
			let toDelete = document.querySelectorAll(".delete-on-rerender");
			let buttonsToReset = document.querySelectorAll(".btn-active");
			toDelete.forEach((el, i) => {
				el.remove();
			});
			buttonsToReset.forEach((el) => {
				if (!el.classList.contains("keep")) {
					el.classList.remove("btn-active");
					el.classList.add("btn-inactive");
				}
			});
			let accumulatedSeconds = 0;
			data.times.forEach((timeEntry, i) => {
				let clonedEntry = timelineParent.querySelector(".time-entry.clone").cloneNode(true);
				clonedEntry.classList.remove("clone");
				clonedEntry.classList.add("delete-on-rerender");
				clonedEntry.style.backgroundColor = timeEntry.colors[0];
				clonedEntry.style.width = `calc(1rem + var(--margin) + ${timeEntry.time} * var(--margin))`;
				clonedEntry.querySelector(".time-entry-time").innerText = timeEntry.time;
				clonedEntry.querySelector(".time-entry-unit").innerText = timeEntry.unit;
				clonedEntry.setAttribute("index", i);
				if (i === data.activeTime) {
					clonedEntry.querySelector(".time-entry-time").classList.add("bold");
				}
				timelineParent.insertBefore(clonedEntry, timelineParent.childNodes[timelineParent.childNodes.length - 2]);

				if (timeEntry.unit == "s") {
					accumulatedSeconds += timeEntry.time;
				} else if (timeEntry.unit == "min") {
					accumulatedSeconds += timeEntry.time * 60;
				} else {
					accumulatedSeconds += timeEntry.time * 60 * 60;
				}
			});
			document.querySelector("#power").style.opacity = data.on ? 1 : 0.3;
			let hoursOfTimeline = Math.floor(accumulatedSeconds / 3600);
			accumulatedSeconds = accumulatedSeconds - hoursOfTimeline * 3600;
			let minutesOfTimeline = Math.floor(accumulatedSeconds / 60);
			let secondsOfTimeline = accumulatedSeconds - minutesOfTimeline * 60;
			document.querySelector("#font-header-info").innerText = `${hoursOfTimeline}h ${minutesOfTimeline}min ${secondsOfTimeline}s`;
			let foundTypeActiveBtn = document.querySelector(`.type-${data.times[data.activeTime].type}`);
			foundTypeActiveBtn.classList.remove("btn-inactive");
			foundTypeActiveBtn.classList.add("btn-active");
			document.querySelector(".color-widget").style.backgroundColor = data.times[data.activeTime].colors[0];
			document.querySelector("#duration-teller").value = data.times[data.activeTime].time;
			document.querySelector("#duration-unit").innerText = data.times[data.activeTime].unit;
			let foundDurationActiveBtn = document.querySelector(`.duration-${data.times[data.activeTime].unit}`);
			foundDurationActiveBtn.classList.remove("btn-inactive");
			foundDurationActiveBtn.classList.add("btn-active");

			if (visualizeChanges && !blockLampUpdate) {
				set();
			}
		}
		render();

		async function set() {
			try {
				let res = await fetch("/set", {
					method: "POST",
					body: JSON.stringify(data),
				});
				if (!res.ok) {
					snackbar("Error while updating, reload and try again.", true);
				} else {
					snackbar("updated");
				}
			} catch (e) {
				snackbar("Error while uploading data to lamp.", true);
				console.error(e);
			}
		}
		async function getData() {
			try {
				let res = await fetch("/state");
				if (res.ok) {
					let serialized = await res.json();
					if (serialized) {
						data = serialized;
						render();
					}
				} else {
					console.error("Couldn't get state", res);
					snackbar("Couldn't get state, restart lamp and try again.", true);
				}
			} catch (e) {
				console.error(e);
				snackbar("Error while getting data from lamp.", true);
			}
		}
		getData();

		function snackbar(msg, isError = false) {
			let elem = document.querySelector("#snackbar");
			let txt = document.querySelector("#snackbar-text");
			txt.innerText = msg;

			elem.style.backgroundColor = isError ? "var(--red)" : "var(--white)";

			elem.style.transform = "translateY(calc(var(--margin) * -1))";
			elem.style.opacity = 1;
			elem.style.pointerEvents = "all";

			setTimeout(
				() => {
					elem.style.transform = "translateY(0px)";
					elem.style.opacity = 0;
					elem.style.pointerEvents = "none";
				},
				isError ? 5000 : 1500
			);
		}
	</script>
</html>
